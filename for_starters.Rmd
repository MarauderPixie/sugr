---
title: "Blood Glucose Diary"
output: 
  html_document:
    toc: true
    toc_float: true
    self_contained: no
    lib_dir: "assets"
    fig_width: 10
    dpi: 540
    theme: sandstone
---

```{r init, echo = F, message=F, warning=F}
## knitr options setzen
knitr::opts_chunk$set(echo = F, warning = F, message = F, fig.align = "center")

## toolbox etc
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggthemes)
library(plotly)
library(viridis)
library(sjPlot)
library(tadaatoolbox)

## read data
sugr    <- readRDS("./data/sugr.rds")
base    <- readRDS("./data/base.rds")
bexpert <- readRDS("./data/bexpert.rds")

## prepare cosmetics
theme_set(theme_readthedown(bg = "#FFFFFF") +
            theme(legend.position = "top"))
```


# Rahmendaten

## BE-Faktor

Zeitraum      | IE/BE
--------------|--------
 0:00 -  8:00 | 1,5
 8:00 - 12:00 | 1.25
12:00 - 14:00 | 1.7
14:00 - 15:30 | 1.5
15:30 - 18:00 | 1.15
18:00 - 24:00 | 1.5


## Basalratenprofil(e)

```{r rahmen_base1}
ggplot(base, aes(x = Uhrzeit, y = Rate_1, group = 1)) +
  geom_line(linejoin = "round") +
  geom_point(size = 3, color = "cadetblue") +
  labs(x = "Uhrzeit", y = "Basalrate (IE/h)", 
       title = "Basalratenprofil 1", 
       subtitle = paste("Tagesgesamtmenge:", sum(base$Rate_1), "IE"))


hover <- ~paste0("bis ", Uhrzeit, " Uhr:",
                 "<br /><b>", Rate_1, " IE</b>")

plot_ly(base, x = ~Uhrzeit/(60*60), y = ~Rate_1) %>%
  add_lines(color = I("black")) %>% 
  add_markers(color = I("cadetblue"), size = I(12), 
              hoverinfo = "hover", text = hover) %>% 
  layout(title = "Basalratenprofil 1", xaxis = list(title = "Uhrzeit"),
         yaxis = list(title = "Basalrate (IE/h)"), hovermode = "closest",
         autosize = T, showlegend = F)
```

# Blutzuckerverläufe

## Alle Messungen

```{r BZ_Gesamt}
sugr %>% 
  filter(BZ_Wert < 350, !is.na(BZ_Wert)) %>% 
  ggplot(aes(x = Zeit, y = BZ_Wert, color = BZ_Wert)) + 
    annotate("rect", fill = "black", alpha = .1,
             xmin = 7201, xmax = 28800, ymin = 0, ymax= Inf) +
    geom_point(size = 1.5) +
    geom_smooth(method = "loess", color = "cadetblue", fill = "cadetblue", alpha = 0.2) +
    geom_hline(yintercept = c(80, 160), color = "red", size = .5, linetype = "dashed") +
    scale_x_continuous(labels = seq(0, 24, 4), 
                       breaks = seq(0, 86400, 14400), 
                       minor_breaks = seq(0, 86400, 7200)) +
    labs(x = "Uhrzeit", y = "Blutzucker (mg/dl)", color = "Blutzucker (mg/dl)") +
    scale_color_viridis()
```


## pro Tag

```{r BZ_pro_Tag, fig.height=12}
sugr %>% 
  filter(BZ_Wert < 350, !is.na(BZ_Wert)) %>% 
  ggplot(aes(x = Zeit, y = BZ_Wert, color = BZ_Wert)) + 
    annotate("rect", fill = "black", alpha = .1,
             xmin = 7201, xmax = 28800, ymin = 0, ymax= Inf) +
    geom_point(size = 2) +
    geom_smooth(method = "loess", color = "cadetblue", fill = "cadetblue", alpha = 0.2) +
    geom_hline(yintercept = c(80, 160), color = "red", size = .5, linetype = "dashed") +
    scale_x_continuous(labels = seq(0, 24, 4), 
                       breaks = seq(0, 86400, 14400), 
                       minor_breaks = seq(0, 86400, 7200)) +
    labs(x = "Uhrzeit", y = "Blutzucker (mg/dl)", color = "Blutzucker (mg/dl)") +
    facet_wrap(~Wochentag, ncol = 2) +
    scale_color_viridis()
```


## schräge _BolusExpert_-Messungen

```{r BZ_BE}
sugr %>% 
  gather(Messung, Wert, BZ_Wert, BE_BZ) %>% 
  mutate(Messung = recode(Messung, "BE_BZ" = "BolusExpert", "BZ_Wert" = "Regulär")) %>% 
  filter(Wert > 0) %>% 
  ggplot(aes(x = Zeit, y = Wert, color = Messung, fill = Messung)) +
    annotate("rect", fill = "black", alpha = .1,
             xmin = 7201, xmax = 28800, ymin = 0, ymax= Inf) +
    geom_point(size = 1.5) +
    geom_smooth(method = "loess", alpha = .2) +
    geom_hline(yintercept = c(80, 160), color = "red", size = .5, linetype = "dashed") +
    scale_x_continuous(labels = seq(0, 24, 4), 
                       breaks = seq(0, 86400, 14400), 
                       minor_breaks = seq(0, 86400, 7200)) +
    labs(x = "Uhrzeit", y = "Blutzucker (mg/dl)") +
    scale_color_viridis(discrete = T) +
    scale_fill_viridis(discrete = T)
```


# Bolus & BEs

## Bolusarten

Unter _"Bolusarten"_ verstehe ich die drei verschiedenen Modi, in denen die Pumpe die Abgabe festhält:

1. die von _BolusExpert_ geschätzte Insulinmenge, die benötigt wird
2. die von der Pumpe angeforderte Menge Insulin
3. die **tatsächlich** abgegebene Menge Insulin

Die angeforderte und die tatsächlich abgegebene Menge ist erwatungsgemäß Deckungsgleich ($r =$ `r cor(sugr$Bolus_abgegeben, sugr$Bolus_gewaehlt, use = "complete.obs")`), dementsprechend werden für die weiteren Beobachtungen jeweils die Werte der tatsächlich abgegebenen Menge verwendet.  
Spannender ist der Unterschied zwischen der _BolusExpert_-Schätzung und der abgegebenen Menge: Zum einen sind die Werte erstaunlich oft **nicht** identisch und zum anderen tauchen mal diese und mal jene auf:

```{r Bolusarten_Messungen}
sugr %>% 
  gather(Messung, Bolus, Bolus_abgegeben, BE_Schaetzung) %>% 
  select(Zeitstempel, Messung, Bolus) %>% 
  filter(!is.na(Bolus)) %>% 
  mutate(Messung = recode(Messung, "BE_Schaetzung" = "BolusExpert", "Bolus_abgegeben" = "tatsächlich abgegeben")) %>% 
  ggplot(aes(x = Zeitstempel, y = Bolus, color = Messung)) + 
    geom_point(alpha = 0.5) +
    labs(title = "Abgegebene Menge Insulin",
         subtitle = "nach Art der Messung",
         x = "Datum", y = "Bolus (IE)") +
    scale_color_viridis(discrete = T)
```

Was genau der Unterschied zwischen den beiden Varianten ist, ist mir noch unklar. Ein t-Test auf die Modi ergibt zumindest weder ein signifikantes Ergebnis, noch eine nennenswerte Effektröße, und das trotz der verhältnismäßig großen Gruppen von jeweils etwa 235 Beobachtungen:

```{r Bolusarten_t_test}
t_test <- sugr %>% 
  gather(Messung, Bolus, Bolus_abgegeben, BE_Schaetzung) %>% 
  mutate(Messung = recode(Messung, "BE_Schaetzung" = "BolusExpert", "Bolus_abgegeben" = "tatsächlich abgegeben")) %>% 
  filter(!is.na(Bolus))

tadaa_t.test(t_test, Bolus, Messung, print = "markdown")
rm(t_test)
```